name: üöÄ Deploy AI Vector Search (Streamlit + FastAPI)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Cho ph√©p trigger th·ªß c√¥ng

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            echo "=============================================="
            echo "üöÄ DEPLOYING AI VECTOR SEARCH DEMO"
            echo "=============================================="
            
            # ============================================
            # CONFIGURATION
            # ============================================
            PROJECT_DIR="/srv/poc_elastik"
            REPO_BRANCH="main"
            
            # Load environment
            export PATH=$PATH:/usr/local/bin:/usr/bin
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -f "$HOME/.bashrc" ] && source "$HOME/.bashrc"
            
            # ============================================
            # 1. CLONE/UPDATE CODE
            # ============================================
            echo ""
            echo ">>> [1/6] C·∫≠p nh·∫≠t source code..."
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Creating project directory..."
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown $USER:$USER "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            
            if [ ! -d ".git" ]; then
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi
            
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            echo "‚úÖ Code updated successfully"
            
            # ============================================
            # 2. SETUP PYTHON ENVIRONMENT
            # ============================================
            echo ""
            echo ">>> [2/6] Thi·∫øt l·∫≠p Python virtual environment..."
            
            # Check Python version
            PYTHON_CMD="python3"
            if ! command -v python3 &> /dev/null; then
              PYTHON_CMD="python"
            fi
            
            echo "Using Python: $($PYTHON_CMD --version)"
            
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              $PYTHON_CMD -m venv venv
            fi
            
            source venv/bin/activate
            
            echo "Upgrading pip..."
            pip install --upgrade pip -q
            
            echo "Installing dependencies..."
            pip install -r requirements.txt -q
            echo "‚úÖ Dependencies installed"
            
            # ============================================
            # 3. CHECK ENVIRONMENT FILE
            # ============================================
            echo ""
            echo ">>> [3/6] Ki·ªÉm tra file .env..."
            
            if [ ! -f ".env" ]; then
              echo "‚ö†Ô∏è  WARNING: .env file not found!"
              echo "Please create .env file with required variables:"
              echo "  - OPENAI_API_KEY"
              echo "  - ES_HOST"
              echo "  - ES_USERNAME (optional)"
              echo "  - ES_PASSWORD (optional)"
            else
              echo "‚úÖ .env file exists"
            fi
            
            # ============================================
            # 4. CHECK ELASTICSEARCH
            # ============================================
            echo ""
            echo ">>> [4/6] Ki·ªÉm tra Elasticsearch..."
            
            ES_HOST="${ES_HOST:-http://localhost:9200}"
            
            if curl -s "$ES_HOST" > /dev/null 2>&1; then
              echo "‚úÖ Elasticsearch is running at $ES_HOST"
            else
              echo "‚ö†Ô∏è  WARNING: Elasticsearch is not responding at $ES_HOST"
              echo "Please ensure Elasticsearch is running"
            fi
            
            # ============================================
            # 5. STOP OLD SERVICES
            # ============================================
            echo ""
            echo ">>> [5/6] D·ª´ng services c≈©..."
            
            # Stop via PM2
            pm2 delete poc-fastapi 2>/dev/null || true
            pm2 delete poc-streamlit 2>/dev/null || true
            
            # Kill any remaining processes
            pkill -f "uvicorn main:app" 2>/dev/null || true
            pkill -f "streamlit run streamlit_app.py" 2>/dev/null || true
            
            sleep 2
            echo "‚úÖ Old services stopped"
            
            # ============================================
            # 6. START NEW SERVICES
            # ============================================
            echo ""
            echo ">>> [6/6] Kh·ªüi ƒë·ªông services m·ªõi..."
            
            # Create logs directory
            mkdir -p logs
            
            # Activate venv for PM2
            VENV_PYTHON="$PROJECT_DIR/venv/bin/python"
            
            # Start FastAPI Backend (port 8000)
            echo "Starting FastAPI on port 8000..."
            pm2 start $VENV_PYTHON \
              --name poc-fastapi \
              --cwd "$PROJECT_DIR" \
              -- -m uvicorn main:app --host 0.0.0.0 --port 8000
            
            sleep 3
            
            # Verify FastAPI is running
            if curl -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "‚úÖ FastAPI is running"
            else
              echo "‚ö†Ô∏è  FastAPI may not be ready yet, waiting..."
              sleep 5
            fi
            
            # Start Streamlit Frontend (port 8501)
            echo "Starting Streamlit on port 8501..."
            pm2 start $VENV_PYTHON \
              --name poc-streamlit \
              --cwd "$PROJECT_DIR" \
              -- -m streamlit run streamlit_app.py \
                --server.port 8501 \
                --server.address 0.0.0.0 \
                --server.headless true \
                --browser.gatherUsageStats false
            
            sleep 3
            
            # ============================================
            # SAVE & VERIFY
            # ============================================
            echo ""
            echo ">>> L∆∞u c·∫•u h√¨nh PM2..."
            pm2 save
            
            echo ""
            echo ">>> Thi·∫øt l·∫≠p PM2 kh·ªüi ƒë·ªông c√πng h·ªá th·ªëng..."
            pm2 startup systemd -u $USER --hp $HOME 2>/dev/null || true
            
            echo ""
            echo "=============================================="
            echo "‚úÖ DEPLOYMENT COMPLETED!"
            echo "=============================================="
            echo ""
            echo "üìç Services:"
            echo "   - FastAPI:   http://localhost:8000"
            echo "   - Streamlit: http://localhost:8501"
            echo "   - API Docs:  http://localhost:8000/docs"
            echo ""
            pm2 list
            echo ""
            echo "üìä To check logs:"
            echo "   pm2 logs poc-fastapi"
            echo "   pm2 logs poc-streamlit"
            echo "=============================================="
