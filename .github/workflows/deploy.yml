name: üöÄ Deploy AI Vector Search (Streamlit + FastAPI)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Cho ph√©p trigger th·ªß c√¥ng

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script_stop: true
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "=============================================="
            echo "üöÄ DEPLOYING AI VECTOR SEARCH DEMO"
            echo "=============================================="
            
            # ============================================
            # CONFIGURATION
            # ============================================
            PROJECT_DIR="/srv/poc_elastik"
            REPO_BRANCH="main"
            
            # Load bash profile ƒë·ªÉ c√≥ ƒë·ªß PATH (nvm, npm, pm2...)
            # D√πng || true ƒë·ªÉ tr√°nh l·ªói khi .bashrc c√≥ interactive checks
            source "$HOME/.bashrc" 2>/dev/null || true
            source "$HOME/.profile" 2>/dev/null || true
            source "$HOME/.nvm/nvm.sh" 2>/dev/null || true
            
            # Load path c∆° b·∫£n + npm global
            export PATH=$PATH:/usr/local/bin:/usr/bin:$HOME/.npm-global/bin:$HOME/.local/bin
            
            # ============================================
            # 1. CLONE/UPDATE CODE
            # ============================================
            echo ""
            echo ">>> [1/5] C·∫≠p nh·∫≠t source code..."
            
            # T·∫°o th∆∞ m·ª•c n·∫øu ch∆∞a c√≥
            if [ ! -d "$PROJECT_DIR" ]; then
              sudo mkdir -p "$PROJECT_DIR"
              sudo chown $USER:$USER "$PROJECT_DIR"
            fi
            
            cd "$PROJECT_DIR"
            
            # Clone code
            if [ ! -d ".git" ]; then
              git clone git@github-poc:${{ github.repository }}.git .
            fi
            
            # Pull code m·ªõi
            git fetch origin $REPO_BRANCH
            git reset --hard origin/$REPO_BRANCH
            echo "‚úÖ Code updated"
            
            # ============================================
            # 2. SETUP PYTHON
            # ============================================
            echo ""
            echo ">>> [2/5] C√†i ƒë·∫∑t th∆∞ vi·ªán Python..."
            
            PYTHON_CMD="python3"
            if ! command -v python3 &> /dev/null; then PYTHON_CMD="python"; fi
            
            if [ ! -d "venv" ]; then
              $PYTHON_CMD -m venv venv
            fi
            
            source venv/bin/activate
            pip install --upgrade pip -q
            pip install -r requirements.txt -q
            echo "‚úÖ Dependencies installed"
            
            # ============================================
            # 3. LOAD ENV & CHECK ELASTICSEARCH
            # ============================================
            echo ""
            echo ">>> [3/5] Load m√¥i tr∆∞·ªùng & Ki·ªÉm tra ES..."
            
            # --- PH·∫¶N QUAN TR·ªåNG: Load .env an to√†n ---
            if [ -f ".env" ]; then
              echo "Loading .env file..."
              set -a  # T·ª± ƒë·ªông export c√°c bi·∫øn ƒë∆∞·ª£c load
              source .env
              set +a
              echo "‚úÖ Loaded environment variables"
            else
              echo "‚ö†Ô∏è  WARNING: .env file not found. App might crash!"
            fi
            
            # Ki·ªÉm tra Elasticsearch
            ES_HOST="${ES_HOST:-http://localhost:9200}"
            if curl -s "$ES_HOST" > /dev/null 2>&1; then
              echo "‚úÖ Elasticsearch is running at $ES_HOST"
            else
              echo "‚ö†Ô∏è  WARNING: Elasticsearch NOT responding at $ES_HOST"
            fi
            
            # ============================================
            # 4. DEPLOY WITH WATCHDOG AUTO-RESTART
            # ============================================
            echo ""
            echo ">>> [4/5] Deploying with watchdog auto-restart..."
            
            # Stop old services first (safely)
            if [ -f "stop_demo.sh" ]; then
              chmod +x stop_demo.sh
              # Run stop in subshell to isolate from deployment process
              (./stop_demo.sh) 2>/dev/null || true
            else
              # Manual safe cleanup using PID files
              for pid_file in logs/watchdog.pid logs/fastapi.pid logs/streamlit.pid logs/ngrok.pid; do
                if [ -f "$pid_file" ]; then
                  kill -9 $(cat "$pid_file") 2>/dev/null || true
                  rm -f "$pid_file"
                fi
              done
            fi
            
            sleep 2
            echo "‚úÖ Old services stopped"
            
            # Make scripts executable
            chmod +x start_demo.sh watchdog.sh deploy.sh 2>/dev/null || true
            
            # Start services with watchdog
            # Run in background and detach to survive SSH disconnect
            nohup ./start_demo.sh > logs/deployment.log 2>&1 &
            START_PID=$!
            
            # Wait for start_demo.sh to complete initialization
            echo "Waiting for services to initialize..."
            sleep 10
            
            echo "‚úÖ Services startup initiated with watchdog auto-restart"
            
            # ============================================
            # 5. VERIFY DEPLOYMENT
            # ============================================
            echo ""
            echo ">>> [5/5] Verifying deployment..."
            
            # Wait longer for services to be ready
            sleep 15
            
            
            # Check FastAPI health
            if curl -s http://localhost:8000/health > /dev/null 2>&1; then
              echo "‚úÖ FastAPI is running on port 8000"
            else
              echo "‚ùå FastAPI health check failed!"
              echo "Last 20 lines of FastAPI log:"
              tail -20 logs/fastapi.log
              exit 1
            fi
            
            # Check Streamlit
            if curl -s http://localhost:8501 > /dev/null 2>&1; then
              echo "‚úÖ Streamlit is running on port 8501"
            else
              echo "‚ö†Ô∏è  Streamlit not responding yet (may still be starting)"
            fi
            
            # Check Watchdog
            if ps aux | grep -v grep | grep "watchdog.sh" > /dev/null; then
              echo "‚úÖ Watchdog is monitoring (auto-restart enabled)"
            else
              echo "‚ö†Ô∏è  Watchdog not detected"
            fi
            
            echo ""
            echo "=============================================="
            echo "‚úÖ DEPLOYMENT COMPLETED!"
            echo "=============================================="
            echo ""
            echo "üìç Access URLs:"
            echo "   - Streamlit: http://YOUR_SERVER_IP:8501"
            echo "   - FastAPI:   http://YOUR_SERVER_IP:8000/docs"
            echo "   - Health:    http://YOUR_SERVER_IP:8000/health"
            echo ""
            echo "üìä Monitor Logs:"
            echo "   tail -f $PROJECT_DIR/logs/watchdog.log"
            echo "   tail -f $PROJECT_DIR/logs/fastapi.log"
            echo "   tail -f $PROJECT_DIR/logs/streamlit.log"
            echo ""
            echo "üîç Watchdog Features:"
            echo "   ‚úì Monitors every 30 seconds"
            echo "   ‚úì Auto-restarts on crash/hang"
            echo "   ‚úì Auto-restarts on high memory (>80%)"
            echo "   ‚úì Max 5 restarts per hour (prevents loops)"
            echo ""
            echo "üõ†Ô∏è  Management Commands:"
            echo "   cd $PROJECT_DIR"
            echo "   ./stop_demo.sh     # Stop all services"
            echo "   ./start_demo.sh    # Start with watchdog"
            echo "=============================================="